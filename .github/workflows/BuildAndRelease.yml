name: Build and create a release when tag is pushed

# Only deploy when a new tag is pushed
on:
    push:
        # tags:
        #   - "v*.*-alpha"
        #   - "v*.*.*"
        branches: [ main ]
    pull_request:
        branches: [ main ] 

# Must match the project() name in CMakeLists.txt
env:
    APP_NAME: pico-infonesPlus

# Allow this workflow to write back to the repository
permissions:
    contents: write
    
# Build binary and send to releases
jobs:
    build-release:
        runs-on: ubuntu-latest
        name: Build and release
        steps:
          
          - name: Install dependencies
            run: |
                 sudo apt update && \
                 sudo apt install -y git python3 && \
                 sudo apt install -y cmake gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential
                 
          - name: Check out this repository
            uses: actions/checkout@v3

          - name: Print Working directory
            run: echo $HOME && pwd && ls -la

          - name: Install Pico SDk
            run: |
                 cd $HOME && \
                 git clone https://github.com/raspberrypi/pico-sdk.git --branch master && \
                 cd pico-sdk/ && \
                 git submodule update --init

          - name: Build all the .uf2 files
            run: |
                 chmod +x build*.sh && \
                 export PICO_SDK_PATH=$HOME/pico-sdk && \
                 ./buildAll.sh

          - name: Create release
            uses: softprops/action-gh-release@v1
            if: startsWith(github.ref, 'refs/tags/')
            with:
                files: |
                       releases/piconesPlusAdaFruitDVISD.uf2
                       releases/piconesPlusFeatherDVI.uf2
                       releases/piconesPlusPimoroniDVI.uf2    
                body_path: CHANGELOG.md
          
         